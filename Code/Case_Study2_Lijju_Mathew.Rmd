---
title: "MSDS-Doing-Datascience-Case-Study2"
author: "Lijju Mathew"
date: "8/9/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Importing Libraries
```{r Importing libraries}
library(readxl)
library(ggplot2)
library(magrittr)
library(dplyr)
library(randomForest)
library(e1071)
library(naivebayes)
library(caret)
library(tidyverse)
library(caret)
library(SuperLearner)
library(gridExtra)
library(lmtest)
library(class)
library(corrplot)
library(GoodmanKruskal)
library(MASS)
library(DMwR)
library(ROSE)
```


## Data Importing
```{r Data Importing}
# Importing all the case study 2 data set from github 
raw_dataset="https://raw.githubusercontent.com/lijjumathew/MSDS-Doing-Datascience-Project2/master/Data/CaseStudy2-data.csv"
no_attrition_dataset="https://raw.githubusercontent.com/lijjumathew/MSDS-Doing-Datascience-Project2/master/Data/CaseStudy2CompSet%20No%20Attrition.csv"
no_salary_dataset="https://raw.githubusercontent.com/lijjumathew/MSDS-Doing-Datascience-Project2/master/Data/CaseStudy2CompSet%20No%20Salary.csv"
raw_data <- read.csv(raw_dataset, sep = ",", header = TRUE)
no_attrition_data <- read.csv(no_attrition_dataset, sep = ",", header = TRUE)
no_salary_data <- read.csv(no_salary_dataset, sep = ",", header = TRUE)

# Checking details of case study 2 dataset
dim(raw_data)
names(raw_data)
head(raw_data)
#View(raw_data)
```


## EDA - Summary Stats
```{r EDA - Summary Stats}
# Get a basic idea of all the variables.
summary(raw_data)
# This gives us a high level view of the case study 2 dataset. 
# We can see that we don't have any NULL values in our case study 2 dataset. 
# We can also see that we just have 140 attrition records out of 870 which is approximately 16%.

str(raw_data)
summary(raw_data)
str(no_attrition_data)
summary(no_attrition_data)
summary(no_salary_data)
str(no_salary_data)

# Drop columns that doesnt make sense to the analysis.
# Employee count (always 1), Standard hours (always 80) and over 18 (always 18) variables are constant.

drops <- c("EmployeeCount", "EmployeeNumber", "Over18", "StandardHours")
raw_data <- raw_data[ , !(names(raw_data) %in% drops)]
```


## Data Imputation
```{r - Data Imputation}
# From the documentation we have reference values for a columns JobInvolvement, JobSatisfaction, PerformanceRating, RelationshipSatisfaction, WorkLifeBalance.
# Lets replace those values with actual values.
# We will also be removing a few columns from our raw data which we wont be using in analysis further.
imp_data <- raw_data %>%
  mutate(JobInvolvement = as.factor(if_else(JobInvolvement == 1,"Low",if_else(JobInvolvement == 2, "Medium",if_else(JobInvolvement == 3, "High", "Very High")))),  JobSatisfaction = as.factor(if_else(JobSatisfaction == 1, "Low",if_else(JobSatisfaction == 2, "Medium",if_else(JobSatisfaction == 3, "High","Very High")))),  PerformanceRating = as.factor(if_else(PerformanceRating == 1, "Low",if_else(PerformanceRating == 2, "Good", if_else(PerformanceRating == 3, "Excellent", "Outstanding")))),RelationshipSatisfaction = as.factor(if_else(RelationshipSatisfaction == 1, "Low",if_else(RelationshipSatisfaction == 2, "Medium", if_else(RelationshipSatisfaction == 3, "High", "Very High")))),WorkLifeBalance = as.factor(if_else(WorkLifeBalance == 1, "Bad",if_else(WorkLifeBalance == 2, "Good", if_else(WorkLifeBalance == 3, "Better", "Best"))))) 

imp_no_attrition <- no_attrition_data %>%
  mutate(JobInvolvement = as.factor(if_else(JobInvolvement == 1,"Low",if_else(JobInvolvement == 2, "Medium",if_else(JobInvolvement == 3, "High", "Very High")))),  JobSatisfaction = as.factor(if_else(JobSatisfaction == 1, "Low",if_else(JobSatisfaction == 2, "Medium",if_else(JobSatisfaction == 3, "High","Very High")))),  PerformanceRating = as.factor(if_else(PerformanceRating == 1, "Low",if_else(PerformanceRating == 2, "Good", if_else(PerformanceRating == 3, "Excellent", "Outstanding")))),RelationshipSatisfaction = as.factor(if_else(RelationshipSatisfaction == 1, "Low",if_else(RelationshipSatisfaction == 2, "Medium", if_else(RelationshipSatisfaction == 3, "High", "Very High")))),WorkLifeBalance = as.factor(if_else(WorkLifeBalance == 1, "Bad",if_else(WorkLifeBalance == 2, "Good", if_else(WorkLifeBalance == 3, "Better", "Best"))))) 

imp_no_salary <- no_salary_data %>%
  mutate(JobInvolvement = as.factor(if_else(JobInvolvement == 1,"Low",if_else(JobInvolvement == 2, "Medium",if_else(JobInvolvement == 3, "High", "Very High")))),  JobSatisfaction = as.factor(if_else(JobSatisfaction == 1, "Low",if_else(JobSatisfaction == 2, "Medium",if_else(JobSatisfaction == 3, "High","Very High")))),  PerformanceRating = as.factor(if_else(PerformanceRating == 1, "Low",if_else(PerformanceRating == 2, "Good", if_else(PerformanceRating == 3, "Excellent", "Outstanding")))),RelationshipSatisfaction = as.factor(if_else(RelationshipSatisfaction == 1, "Low",if_else(RelationshipSatisfaction == 2, "Medium", if_else(RelationshipSatisfaction == 3, "High", "Very High")))),WorkLifeBalance = as.factor(if_else(WorkLifeBalance == 1, "Bad",if_else(WorkLifeBalance == 2, "Good", if_else(WorkLifeBalance == 3, "Better", "Best"))))) 

classification_data  <- imp_data

summary(imp_data)

# Separate continuous and categorical variables for analysis
imp_data_conti <- imp_data[, !sapply(imp_data, is.factor)]
imp_data_categ <- imp_data[, sapply(imp_data, is.factor)]
```

## EDA - Correlation in Predictors
```{r EDA - Correlation in Predictors}
# Computing the p value of correlations
cor.mtest <- function(mat, ...) {
    mat <- as.matrix(mat)
    n <- ncol(mat)
    p.mat<- matrix(NA, n, n)
    diag(p.mat) <- 0
    for (i in 1:(n - 1)) {
        for (j in (i + 1):n) {
            tmp <- cor.test(mat[, i], mat[, j], ...)
            p.mat[i, j] <- p.mat[j, i] <- tmp$p.value
        }
    }
  colnames(p.mat) <- rownames(p.mat) <- colnames(mat)
  p.mat
}

p.mat <- cor.mtest(imp_data_conti)
correlation <- cor(imp_data_conti)
# Correlation plot with significance level of 0.05
corrplot::corrplot(correlation, type="upper", order="hclust", title ="correlation", p.mat = p.mat, sig.level = 0.05)

cat_cor<- GKtauDataframe(imp_data_categ)
plot(cat_cor, corrColors = "blue")
```

EDA - Correlation Analysis. Below variables are correlated to each other
1) YearsSinceLastPromotion -> YearsWithCurrManager, YearsInCurrentRole, YearsAtCompany, TotalWorkingYears
2) YearsAtCompany -> JobLevel, MonthlyIncome
3) Age -> TotalWorkingYears, JobLevel, MonthlyIncome
4) TotalWorkingYears -> JobLevel, MonthlyIncome
5) Department -> JobRole

## EDA - Histogram, Scatterplot, Boxplots
```{r EDA - Histogram and Scatterplot}
# Histogram of each variable
# Scatter Plot
pairs(imp_data_conti, pch=19)

# Box Plot
boxplot(imp_data_conti)
boxplot(imp_data_conti$MonthlyIncome, main="Boxplot Monthly Income")
```


## EDA - Observations - Individual Features
```{r EDA - Observations - Individual Features}
# Employee Personal Demographics - Numerical Variables
p1 <- ggplot(imp_data) + geom_histogram(aes(Age), binwidth = 5, fill = "light green",col = "black")
p2 <- ggplot(imp_data) + geom_histogram(aes(DistanceFromHome), binwidth = 5, fill = "light green",col = "black")
p3 <- ggplot(imp_data) + geom_histogram(aes(NumCompaniesWorked), binwidth = 2, fill = "light green",col = "black")
p4 <- ggplot(imp_data) + geom_histogram(aes(TotalWorkingYears), binwidth = 4, fill = "light green",col = "black")

grid.arrange(p1, p2, p3, p4, ncol = 2, nrow = 2)

# Employee Billing Rate Demographics - Numerical Variables
p1 <- ggplot(imp_data) + geom_histogram(aes(HourlyRate), binwidth = 5, fill = "light green",col = "black")
p2 <- ggplot(imp_data) + geom_histogram(aes(DailyRate), binwidth = 100, fill = "light green",col = "black")
p3 <- ggplot(imp_data) + geom_histogram(aes(MonthlyRate), binwidth = 1000, fill = "light green",col = "black")

grid.arrange(p1, p2, p3, nrow = 3)
#Observations :
#There seems to be no clear cut pattern observed in these rates.

#Employee Work Demographics - Numerical Variables
p1 <- ggplot(imp_data) + geom_histogram(aes(Age), binwidth = 5, fill = "light green",col = "black")
p2 <- ggplot(imp_data) + geom_histogram(aes(PercentSalaryHike), binwidth = 1, fill = "light green",col = "black")
p3 <- ggplot(imp_data) + geom_histogram(aes(YearsAtCompany), binwidth = 2, fill = "light green",col = "black")
p4 <- ggplot(imp_data) + geom_histogram(aes(YearsInCurrentRole), binwidth = 2, fill = "light green",col = "black")
p5 <- ggplot(imp_data) + geom_histogram(aes(YearsSinceLastPromotion), binwidth = 2, fill = "light green",col = "black")
p6 <- ggplot(imp_data) + geom_histogram(aes(YearsWithCurrManager), binwidth = 2, fill = "light green",col = "black")
p7 <- ggplot(imp_data) + geom_histogram(aes(MonthlyIncome), binwidth = 1000, fill = "light green",col = "black")
p8 <- ggplot(imp_data) + geom_histogram(aes(DistanceFromHome), binwidth = 5, fill = "light green",col = "black")
p9 <- ggplot(imp_data) + geom_histogram(aes(NumCompaniesWorked), binwidth = 2, fill = "light green",col = "black")

grid.arrange(p1, p2, p3, p4, p5, p6,p7,p8,p9 ,nrow = 3, ncol = 3)
#Observations:
#All 6 variables are right skewed 

#Employee Personal Demographics - Categorical Variables
p1<- imp_data %>%
  dplyr::group_by(Gender) %>%
  dplyr::summarise(counts = n()) %>%
  ggplot(aes(x = as.factor(Gender), y = counts)) + geom_bar(stat = 'identity', fill = "light green") + ggtitle("Gender") +geom_text(aes(label=counts), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25) + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) + scale_y_continuous(limits = c(0, 900))

p2<- imp_data %>%
  dplyr::group_by(Education) %>%
  dplyr::summarise(counts = n()) %>%
  ggplot(aes(x = as.factor(Education), y = counts)) + geom_bar(stat = 'identity', fill = "light green") + ggtitle("Education") +geom_text(aes(label=counts), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25) + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) + scale_y_continuous(limits = c(0, 650))

p3 <- imp_data %>%
  dplyr::group_by(EducationField) %>%
  dplyr::summarise(counts = n()) %>%
  ggplot(aes(x = as.factor(EducationField), y = counts)) + geom_bar(stat = 'identity', fill = "light green") + ggtitle("Education Field") +geom_text(aes(label=counts), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25) + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) + scale_y_continuous(limits = c(0, 650))

p4 <- imp_data %>%
  dplyr::group_by(MaritalStatus) %>%
  dplyr::summarise(counts = n()) %>%
  ggplot(aes(x = as.factor(MaritalStatus), y = counts)) + geom_bar(stat = 'identity', fill = "light green")+ ggtitle("Marital Status") +geom_text(aes(label=counts), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25) + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) + scale_y_continuous(limits = c(0, 750))

p5 <- imp_data %>%
  dplyr::group_by(RelationshipSatisfaction) %>%
  dplyr::summarise(counts = n()) %>%
  ggplot(aes(x = as.factor(RelationshipSatisfaction), y = counts)) + geom_bar(stat = 'identity', fill = "light green") + ggtitle("Relationship Satisfaction") +geom_text(aes(label=counts), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25) + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())+ scale_y_continuous(limits = c(0, 500))

p6 <- imp_data %>%
  dplyr::group_by(WorkLifeBalance) %>%
  dplyr::summarise(counts = n()) %>%
  ggplot(aes(x = as.factor(WorkLifeBalance), y = counts)) + geom_bar(stat = 'identity', fill = "light green")+ ggtitle("Work Life Balance") +geom_text(aes(label=counts), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25) + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) + scale_y_continuous(limits = c(0, 950))

grid.arrange(p1, p2, p3, p4, p5, p6, nrow = 2, ncol = 3)

#Employee Work Demographics - Categorical Variables
p1 <- imp_data %>%
  dplyr::group_by(BusinessTravel) %>%
  dplyr::summarise(counts = n()) %>%
  ggplot(aes(x = as.factor(BusinessTravel), y = counts)) + geom_bar(stat = 'identity', fill = "light green") + ggtitle("Business Travel") +geom_text(aes(label=counts), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ theme(plot.title = element_text(size =10),axis.text.x = element_text(size =10,angle = 45, hjust = 1),axis.title.x=element_blank())+ scale_y_continuous(limits = c(0, 1100))



p2 <- imp_data %>%
  dplyr::group_by(EnvironmentSatisfaction) %>%
  dplyr::summarise(counts = n()) %>%
  ggplot(aes(x = as.factor(EnvironmentSatisfaction), y = counts)) + geom_bar(stat = 'identity', fill = "light green") + ggtitle("Environment Satisfaction") + geom_text(aes(label=counts), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25) + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =10,angle = 45, hjust = 1),axis.title.x=element_blank()) + scale_y_continuous(limits = c(0, 500))

p3 <- imp_data %>%
  dplyr::group_by(JobInvolvement) %>%
  dplyr::summarise(counts = n()) %>%
  ggplot(aes(x = as.factor(JobInvolvement), y = counts)) + geom_bar(stat = 'identity', fill = "light green") + ggtitle("Job Involvement") +geom_text(aes(label=counts), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ theme(plot.title = element_text(size =10),axis.text.x = element_text(size =10,angle = 45, hjust = 1),axis.title.x=element_blank()) + scale_y_continuous(limits = c(0, 900))


p4 <- imp_data %>%
  dplyr::group_by(JobSatisfaction) %>%
  dplyr::summarise(counts = n()) %>%
  ggplot(aes(x = as.factor(JobSatisfaction), y = counts)) + geom_bar(stat = 'identity', fill = "light green") + ggtitle("Job Satisfaction") +geom_text(aes(label=counts), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25) + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) + scale_y_continuous(limits = c(0, 500))

p5 <- imp_data %>%
  dplyr::group_by(OverTime) %>%
  dplyr::summarise(counts = n()) %>%
  ggplot(aes(x = as.factor(OverTime), y = counts)) + geom_bar(stat = 'identity', fill = "light green") + ggtitle("Over Time") +geom_text(aes(label=counts), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) + scale_y_continuous(limits = c(0, 1100))


p6 <- imp_data %>%
  dplyr::group_by(PerformanceRating) %>%
  dplyr::summarise(counts = n()) %>%
  ggplot(aes(x = as.factor(PerformanceRating), y = counts)) + geom_bar(stat = 'identity', fill = "light green") + ggtitle("Performance Rating") +geom_text(aes(label=counts), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) + scale_y_continuous(limits = c(0, 1300))

grid.arrange(p1,p2,p3,p4,p5,p6,nrow = 2)

p1 <- imp_data %>%
  dplyr::group_by(Department) %>%
  dplyr::summarise(counts = n()) %>%
  ggplot(aes(x = as.factor(Department), y = counts)) + geom_bar(stat = 'identity', fill = "light green") + ggtitle("Department") +geom_text(aes(label=counts), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ theme(plot.title = element_text(size =10),axis.text.x = element_text(size = 7, angle = 45, hjust = 1),axis.title.x=element_blank())

p2 <- imp_data %>%
  dplyr::group_by(JobRole) %>%
  dplyr::summarise(counts = n()) %>%
  ggplot(aes(x = as.factor(JobRole), y = counts)) + geom_bar(stat = 'identity', fill = "light green") + ggtitle("Job Role") +geom_text(aes(label=counts), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25) + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

grid.arrange(p1,p2 ,ncol = 2)
```

EDA - Observations - Univariate Analysis
1) MonthlyIncome has outliers.
2) Right Skewed data - JobLevel, MonthlyIncome, PercentageSalaryHike, TotalWorkingYears, YearsAtCompany, YearsSinceLastPromotion
3) More than 50% employees are male.
4) Almost 70% of the employees are from Life Science and Medical Background.
5) 47% of the employees are married where as 22% are divorced.
6) More than 60% of the employees feel they have a better work life balance.
7) More than 70% of the employees Travel rarely for work.
8) More than 70% of the people seem to be working over time


## EDA - Observations - Multivariate Analysis
```{r EDA - Observations - Multivariate Analysis}
#After looking at every feature individually, let's now do some bivariate/multivariate analysis. Here we'll explore the independent variables with respect to the target variable. The objective is to discover hidden relationships between the independent variables and the target variable.
#Employee Personal Demographics - Numerical Variables
p1 <- imp_data %>%
  ggplot(aes(x = Age, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Age") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p2 <- imp_data %>%
  ggplot(aes(x = DistanceFromHome, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Distance From Home")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p3 <- imp_data %>%
  ggplot(aes(x = NumCompaniesWorked, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Number of Companies")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

p4 <- imp_data %>%
  ggplot(aes(x = TotalWorkingYears, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Total Working Years")  + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())

grid.arrange(p1, p2, p3, p4, nrow = 2, ncol = 2)

#Employee Billing Rate Demographics - Numerical Variables
p1 <- imp_data %>%
  ggplot(aes(x = HourlyRate, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Hourly Rate") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())


p2 <- imp_data %>%
  ggplot(aes(x = DailyRate, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Daily Rate") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())


p3 <- imp_data %>%
  ggplot(aes(x = MonthlyRate, fill = Attrition)) + geom_density(alpha = 0.5)+ ggtitle("Monthly Rate") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())


grid.arrange(p1, p2, p3)

# Employee Work Demographics - Numerical Variables
p1 <- imp_data %>%
  ggplot(aes(x = MonthlyIncome, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Monthly Income") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())


p2 <- imp_data %>%
  ggplot(aes(x = PercentSalaryHike, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Percentage Salary Hike") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())


p3 <- imp_data %>%
  ggplot(aes(x = YearsAtCompany, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Years At Company") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())


p4 <- imp_data %>%
  ggplot(aes(x = YearsInCurrentRole, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Years in Current Role") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())


p5 <- imp_data %>%
  ggplot(aes(x = YearsSinceLastPromotion, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Years Since Last Promotion") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())


p6 <- imp_data %>%
  ggplot(aes(x = YearsWithCurrManager, fill = Attrition)) + geom_density(alpha = 0.5) + ggtitle("Years With Current Manager") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())


grid.arrange(p1, p2, p3, p4, p5, p6 , nrow = 3, ncol = 2)

#Employee Personal Demographics - Categorical Variables
p1 <- imp_data %>%
  dplyr::group_by(Gender) %>%
  dplyr::summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = Gender, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "light green") + ggtitle("Attrition Rate - Gender") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 20))


p2 <- imp_data %>%
  dplyr::group_by(Education) %>%
  dplyr::summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = Education, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "light green") + ggtitle("Attrition Rate - Education") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 20))

p3 <- imp_data %>%
  dplyr::group_by(EducationField) %>%
  dplyr::summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = EducationField, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "light green") + ggtitle("Attrition Rate - Education Field") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 30))

p4 <- imp_data %>%
  dplyr::group_by(MaritalStatus) %>%
  dplyr::summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = MaritalStatus, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "light green") + ggtitle("Attrition Rate - Marital Status") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 40))

p5 <- imp_data %>%
  dplyr::group_by(RelationshipSatisfaction) %>%
  dplyr::summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = as.factor(RelationshipSatisfaction), y = attrition_rate))+ geom_bar(stat = 'identity',fill = "light green") + ggtitle("Attrition Rate - Relationship Satisfaction") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 40))

p6 <- imp_data %>%
  dplyr::group_by(WorkLifeBalance) %>%
  dplyr::summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = as.factor(WorkLifeBalance), y = attrition_rate))+ geom_bar(stat = 'identity',fill = "light green") + ggtitle("Attrition Rate - Work Life Balance") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank())  + geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.15)+ scale_y_continuous(limits = c(0, 40))


grid.arrange(p1, p2, p3, p4, p5, p6, nrow = 2, ncol = 3)

#Employee Work Demographics - Categorical Variables
p1 <- imp_data %>%
  dplyr::group_by(BusinessTravel) %>%
  dplyr::summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = BusinessTravel, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "light green") + ggtitle("Attrition Rate - Business Travel") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 30))

p2 <- imp_data %>%
  dplyr::group_by(EnvironmentSatisfaction) %>%
  dplyr::summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = EnvironmentSatisfaction, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "light green") + ggtitle("Attrition Rate - Environment Satisfaction") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 30))

p3 <- imp_data %>%
  dplyr::group_by(JobInvolvement) %>%
  dplyr::summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = JobInvolvement, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "light green") + ggtitle("Attrition Rate - Job Involvement") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 40))

p4 <- imp_data %>%
  dplyr::group_by(JobSatisfaction) %>%
  dplyr::summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = JobSatisfaction, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "light green") + ggtitle("Attrition Rate - Job Satisfaction") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 30))

p5 <- imp_data %>%
  dplyr::group_by(OverTime) %>%
  dplyr::summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = OverTime, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "light green") + ggtitle("Attrition Rate - Over Time") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 35))

p6 <- imp_data %>%
  dplyr::group_by(PerformanceRating) %>%
  dplyr::summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = as.factor(PerformanceRating), y = attrition_rate))+ geom_bar(stat = 'identity',fill = "light green") + ggtitle("Attrition Rate - Performance Rating") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)+ scale_y_continuous(limits = c(0, 20))

grid.arrange(p1, p2, p3, p4, p5, p6, nrow = 2, ncol = 3)

p1 <- imp_data %>%
  dplyr::group_by(Department) %>%
  dplyr::summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = Department, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "light green") + ggtitle("Attrition Rate - Department") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)

p2 <- imp_data %>%
  dplyr::group_by(JobRole) %>%
  dplyr::summarise(attrition_rate = round((sum(if_else(Attrition == "Yes",1,0))/n()*100),2)) %>%
  ggplot(aes(x = JobRole, y = attrition_rate))+ geom_bar(stat = 'identity',fill = "Orange") + ggtitle("Job Role - Attrition Rate") + theme(plot.title = element_text(size =10),axis.text.x = element_text(size =7,angle = 45, hjust = 1),axis.title.x=element_blank()) +geom_text(aes(label=attrition_rate), size = 2.5, position=position_dodge(width=0.2), vjust=-0.25)

p2

grid.arrange(p1, p2, ncol = 2)

```

EDA - Observations - Bi/Multivariate Analysis
1) Younger employees within 25-35 years have a higher attrition rate.
2) We see a lower attrition rate when the Distance from home is within 10 units. The attrition rate increase post 10 units.
3) The attrition rate tends to be higher with employees who have worked with 5 to 7 companies.
4) We observe a peak in attrition rate at a monthly income approx. 2500.
5) We also see a peak in attrition rate when the employee is with the company for 0-2 years approx.
6) #Attrition rate is very high among employees from HR, Marketing and Technical backgrounds.
7) As expected, the attrition rate is very high among employees who have a bad work life balance.
8) Attrition rate is higher among people who travel frequently.
9) Its also higher among employees who have a low environment satisfaction, low job involvement and low job satisfaction.
10) The attrition rate is almost 30% among employees who work over time.
11) Sales department have the highest attrition at 21% whereas Sales Representatives have the highest attrition at 45%.

## Data splitting - Classification
```{r Data splitting - Classification}
set.seed(1234)
splitPerc = .70
trainIndices = sample(1:dim(classification_data)[1],round(splitPerc * dim(classification_data)[1]))
train = classification_data[trainIndices,]
test = classification_data[-trainIndices,]

# 50-50 SMOTE down sampling
train_down_sampled <- SMOTE(form = Attrition~.,data = train, k = 10, perc.over = 100)


# ROSE Down sampling
train_bal_r <- ROSE(Attrition ~ ., data = train)$data


train_sampled <- train_down_sampled

```

## Basic Naive bayes model
```{r Basic Naive bayes model}
#Split train and test model
set.seed(1234)
model.naive <- naiveBayes(Attrition ~ ., data=train_sampled[,-c(1)])
attrition.pred.naive <- predict(model.naive, test[,-c(1)], type="class")
confusionMatrix(attrition.pred.naive, test$Attrition)
```


## Train model with Naive bayes method and get importance of predictors
```{r train model with Naive bayes method and get importance of predictors}
# Prepare training scheme
control <- trainControl(method="repeatedcv", number=10, repeats=3, classProbs = TRUE)
set.seed(1234)
# Train the model
model.naive.t <- train( Attrition ~ ., data=train_sampled[, -c(1)], method="naive_bayes", trControl=control)
attrition.pred.naive.t <- predict(model.naive.t, test[-c(1)])
confusionMatrix(attrition.pred.naive.t, test$Attrition)

# Top 10 Glmnet predictor ranking
importance.naive.t <- varImp(model.naive.t, scale=FALSE)
rank.naive.t <- importance.naive.t$importance
write.csv(rank.naive.t, "rank.naive.t.csv")
rank.naive.t <- read.csv("rank.naive.t.csv", header=TRUE)
colnames(rank.naive.t) <- c("Predictors", "Importance")
rank.naive.t <- rank.naive.t[order(rank.naive.t$Importance, decreasing = TRUE),]
ggplot(rank.naive.t[1:20,], aes(x=reorder(Predictors, Importance),y=Importance)) + geom_bar(stat = "identity") + coord_flip() + labs(title="Importance of Predictors", x="Predictors", y="Importance") +theme(axis.text.x=element_text(hjust=0.5, vjust=0.5, size = 12))+theme(axis.text.y=element_text(size = 12))
```

## Custom Naive Bayes model1
```{r Custom Naive Bayes model1}
set.seed(1234)
nb_model1 <- Attrition ~ OverTime + MaritalStatus + StockOptionLevel + +MonthlyIncome + TotalWorkingYears + JobLevel + YearsAtCompany + YearsInCurrentRole
model.naive.ct <- naiveBayes(nb_model1, data=train_sampled)
attrition.pred.naive.ct <- predict(model.naive.ct, test, type="class")
confusionMatrix(attrition.pred.naive.ct, test$Attrition)
```

## Custom Naive Bayes model2
```{r Custom Naive Bayes model2}
set.seed(1234)

nb_model2 <- Attrition ~ OverTime + MaritalStatus + MonthlyIncome + TotalWorkingYears + JobLevel + YearsAtCompany + JobSatisfaction  + DistanceFromHome + NumCompaniesWorked + WorkLifeBalance + JobRole + StockOptionLevel 
model.naive.ct <- naiveBayes(nb_model2, data=train_sampled)
attrition.pred.naive.ct <- predict(model.naive.ct, test, type="class")
confusionMatrix(attrition.pred.naive.ct, test$Attrition)
```

## Custom Naive Bayes model3
```{r Custom Naive Bayes model3}
set.seed(1234)
 Attrition ~ OverTime + MonthlyIncome + MaritalStatus + StockOptionLevel  + JobSatisfaction + DistanceFromHome + YearsWithCurrManager
nb_model3 <- Attrition ~ OverTime + MonthlyIncome + MaritalStatus + StockOptionLevel  + JobSatisfaction + DistanceFromHome + YearsWithCurrManager 

model.naive.ct <- naiveBayes(nb_model3, data=train_sampled)
attrition.pred.naive.ct <- predict(model.naive.ct, test, type="class")
confusionMatrix(attrition.pred.naive.ct, test$Attrition)
```

From the above Naive Bayes Models, Model 3 with predictors (OverTime + MonthlyIncome + MaritalStatus + StockOptionLevel  + JobSatisfaction + DistanceFromHome + YearsWithCurrManager) gave better sensitiviy(69%) and specificity(72%)


## Train model with knn and get importance of predictors
```{r Train model with knn and get importance of predictors} 
#Prepare training scheme
control <- trainControl(method="repeatedcv", number=10, repeats=3)
set.seed(1234)
#Train the model
model.knn <- train( Attrition ~ ., data=train_sampled, method="knn", trControl=control)
attrition.pred.knn <- predict(model.knn, test)
confusionMatrix(attrition.pred.knn, test$Attrition)
#Top 10 predictor ranking
importance.knn <- varImp(model.knn, scale=FALSE)
rank.knn <- importance.knn$importance
write.csv(rank.knn, "rank.knn.csv")
rank.knn <- read.csv("rank.knn.csv", header=TRUE)
colnames(rank.knn) <- c("Predictors", "Importance")
rank.knn <- rank.knn[order(rank.knn$Importance, decreasing = TRUE),]
ggplot(rank.knn[1:20,], aes(x=reorder(Predictors, Importance),y=Importance)) + geom_bar(stat = "identity") + coord_flip() + labs(title="Importance of Predictors", x="Predictors", y="Importance") +theme(axis.text.x=element_text(hjust=0.5, vjust=0.5, size = 12))+theme(axis.text.y=element_text(size = 12))
```

## Custom knn model1

```{r Custom knn model1}
#Create training and test data
set.seed(1234)
knn_model1 <- Attrition ~ OverTime + MaritalStatus + StockOptionLevel + +MonthlyIncome + TotalWorkingYears + JobLevel + YearsAtCompany + YearsInCurrentRole

# k-Nearest Neighbours
fit_knn <- train(knn_model1,train_sampled,method = 'knn',trControl = trainControl(method = 'repeatedcv',number = 3))
fit_knn
Predictions_knn <- predict(fit_knn,test)

#Set the training control method
trainMethod <- trainControl(method = "repeatedcv", number =  25, repeats = 5, summaryFunction = twoClassSummary, classProbs = TRUE)

fit.knn <- train(knn_model1, data = train_sampled, method = "knn", metric = "Spec", trControl = trainMethod, preProcess = c("center","scale"), tuneLength = 31)
pred.knn <- predict(fit.knn, test)
summary(pred.knn)
confusionMatrix(pred.knn, test$Attrition)
```

## Custom knn model2

```{r Custom knn model2}
#Create training and test data
set.seed(1234)
knn_model2 <- Attrition ~ OverTime + MaritalStatus + MonthlyIncome + TotalWorkingYears + JobLevel + YearsAtCompany + JobSatisfaction  + DistanceFromHome + NumCompaniesWorked + WorkLifeBalance + JobRole + StockOptionLevel 

# k-Nearest Neighbours
fit_knn <- train(knn_model2,train_sampled,method = 'knn',trControl = trainControl(method = 'repeatedcv',number = 3))
fit_knn
Predictions_knn <- predict(fit_knn,test)

#Set the training control method
trainMethod <- trainControl(method = "repeatedcv", number =  25, repeats = 5, summaryFunction = twoClassSummary, classProbs = TRUE)

fit.knn <- train(knn_model2, data = train_sampled, method = "knn", metric = "Spec", trControl = trainMethod, preProcess = c("center","scale"), tuneLength = 31)
pred.knn <- predict(fit.knn, test)
summary(pred.knn)
confusionMatrix(pred.knn, test$Attrition)
```


## Custom knn model3
```{r Custom knn model3}
#Create training and test data
set.seed(1234)
knn_model3 <- Attrition ~ OverTime + MonthlyIncome + MaritalStatus + StockOptionLevel  + JobSatisfaction + DistanceFromHome + YearsWithCurrManager 

# k-Nearest Neighbours
fit_knn <- train(knn_model3,train_sampled,method = 'knn',trControl = trainControl(method = 'repeatedcv',number = 3))
fit_knn
Predictions_knn <- predict(fit_knn,test)

#Set the training control method
trainMethod <- trainControl(method = "repeatedcv", number =  25, repeats = 5, summaryFunction = twoClassSummary, classProbs = TRUE)

fit.knn <- train(knn_model3, data = train_sampled, method = "knn", metric = "Spec", trControl = trainMethod, preProcess = c("center","scale"), tuneLength = 31)
pred.knn <- predict(fit.knn, test)
summary(pred.knn)
confusionMatrix(pred.knn, test$Attrition)
```

From the above KNN, Model 1 with predictors (OverTime + MaritalStatus + StockOptionLevel + +MonthlyIncome + TotalWorkingYears + JobLevel + YearsAtCompany + YearsInCurrentRole) gave better sensitivity(67%) and specificity(64%).

But the Naive Bayes Model3 has better sensitivity(69%) and specificity(72%). So for further predictions we will use Naive Bayes Model 3.


## Naive Bayes Model for Predicting Attrition
```{r Naive Bayes Model for Predicting Attrition}

set.seed(1234)

nb_model3 <- Attrition ~ OverTime + MonthlyIncome + MaritalStatus + StockOptionLevel  + JobSatisfaction + DistanceFromHome + YearsWithCurrManager 
test <- no_attrition_data
model.naive.ct <- naiveBayes(nb_model3, data=raw_data)
attrition.pred.naive.ct <- predict(model.naive.ct, test, type="class")
attrition_prediction <- data.frame(ID=test$ID,Attrition=attrition.pred.naive.ct)
path_out = '/Users/lijjumathew/Code/Github/MSDS-Doing-Datascience-Project2/Results/'
fileName = paste(path_out, 'Case2PredictionsMathewAttrition..csv',sep = '')
#write.csv(attrition_prediction, fileName, row.names = F)
```

## Linear Regression data prep
```{r Linear Regression data prep}
#Create training and test data
set.seed(1234)
# Converting Character Variable into Numeric Variables

conv.attr.reg <- function(data, ...) {
data$AttritionNum[data$Attrition== "Yes"] <-1
data$AttritionNum[data$Attrition== "No"] <-0

data$BusinessTravelNum[data$BusinessTravel== "Non-Travel"] <-1
data$BusinessTravelNum[data$BusinessTravel== "Travel_Rarely"] <-2
data$BusinessTravelNum[data$BusinessTravel== "Travel_Frequently"] <-3

data$DepartmentNum[data$Department== "Human Resources"] <-1
data$DepartmentNum[data$Department== "Research & Development"] <-2
data$DepartmentNum[data$Department== "Sales"] <-3

data$EducationFieldNum[data$EducationField== "Human Resources"] <-1
data$EducationFieldNum[data$EducationField== "Life Sciences"] <-2
data$EducationFieldNum[data$EducationField== "Marketing"] <-3
data$EducationFieldNum[data$EducationField== "Medical"] <-4
data$EducationFieldNum[data$EducationField== "Other"] <-5
data$EducationFieldNum[data$EducationField== "Technical Degree"] <-6

data$GenderNum[data$Gender== "Female"] <-1
data$GenderNum[data$Gender== "Male"] <-2

data$JobRoleNum[data$JobRole== "Human Resources"] <-1
data$JobRoleNum[data$JobRole== "Healthcare Representative"] <-2
data$JobRoleNum[data$JobRole== "Laboratory Technician"] <-3
data$JobRoleNum[data$JobRole== "Manager"] <-4
data$JobRoleNum[data$JobRole== "Manufacturing Director"] <-5
data$JobRoleNum[data$JobRole== "Research Director"] <-6
data$JobRoleNum[data$JobRole== "Research Scientist"] <-7
data$JobRoleNum[data$JobRole== "Sales Executive"] <-8
data$JobRoleNum[data$JobRole== "Sales Representative"] <-9

data$MaritalStatusNum[data$MaritalStatus== "Divorced"] <-1
data$MaritalStatusNum[data$MaritalStatus== "Married"] <-2
data$MaritalStatusNum[data$MaritalStatus== "Single"] <-3

data$OverTimeNum[data$OverTime== "Yes"] <-1
data$OverTimeNum[data$OverTime== "No"] <-0

data$JobInvolvementNum[data$JobInvolvement== "Low"] <-1
data$JobInvolvementNum[data$JobInvolvement== "Medium"] <-2
data$JobInvolvementNum[data$JobInvolvement== "High"] <-3
data$JobInvolvementNum[data$JobInvolvement== "Very High"] <-4

data$JobSatisfactionNum[data$JobSatisfaction== "Low"] <-1
data$JobSatisfactionNum[data$JobSatisfaction== "Medium"] <-2
data$JobSatisfactionNum[data$JobSatisfaction== "High"] <-3
data$JobSatisfactionNum[data$JobSatisfaction== "Very High"] <-4

data$PerformanceRatingNum[data$PerformanceRating== "Low"] <-1
data$PerformanceRatingNum[data$PerformanceRating== "Good"] <-2
data$PerformanceRatingNum[data$PerformanceRating== "Excellent"] <-3
data$PerformanceRatingNum[data$PerformanceRating== "Outstanding"] <-4

data$RelationshipSatisfactionNum[data$RelationshipSatisfaction== "Low"] <-1
data$RelationshipSatisfactionNum[data$RelationshipSatisfaction== "Medium"] <-2
data$RelationshipSatisfactionNum[data$RelationshipSatisfaction== "High"] <-3
data$RelationshipSatisfactionNum[data$RelationshipSatisfaction== "Very High"] <-4

data$WorkLifeBalanceNum[data$WorkLifeBalance== "Bad"] <-1
data$WorkLifeBalanceNum[data$WorkLifeBalance== "Good"] <-2
data$WorkLifeBalanceNum[data$WorkLifeBalance== "Better"] <-3
data$WorkLifeBalanceNum[data$WorkLifeBalance== "Best"] <-4

drops <- c("Attrition", "BusinessTravel", "Department","EducationField","Gender","JobRole","MaritalStatus","OverTime","JobInvolvement", "JobSatisfaction", "PerformanceRating", "RelationshipSatisfaction","WorkLifeBalance")
data <- data[ , !(names(data) %in% drops)]

data
}
```

## Identifying Top 3 factors - Correlation Test
```{r Identifying Top 3 factors - Correlation Test}
corr_data <- conv.attr.reg(classification_data)

cor.test(corr_data[,"AttritionNum"], corr_data[,"BusinessTravelNum"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"DailyRate"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"DistanceFromHome"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"EducationFieldNum"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"GenderNum"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"HourlyRate"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"MaritalStatusNum"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"MonthlyIncome"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"MonthlyRate"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"NumCompaniesWorked"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"OverTimeNum"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"PercentSalaryHike"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"TotalWorkingYears"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"YearsAtCompany"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"YearsInCurrentRole"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"YearsSinceLastPromotion"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"YearsWithCurrManager"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"YearsWithCurrManager"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"JobRoleNum"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"DepartmentNum"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"JobLevel"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"JobRoleNum"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"JobInvolvementNum"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"JobSatisfactionNum"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"PerformanceRatingNum"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"RelationshipSatisfactionNum"])
cor.test(corr_data[,"AttritionNum"], corr_data[,"WorkLifeBalanceNum"])
```

## Linear Regression - Full Model Attrition 
```{r Linear Regression - Full Model Attrition }
train_sampled_reg <- conv.attr.reg(train_sampled)
full_model <-AttritionNum~.
fit1 <- lm(full_model, data = train_sampled_reg)
summary(fit1)
```

With Full Model following predictors turned to be statistically significant.
Age, DistanceFromHome, EnvironmentSatisfaction, NumCompaniesWorked, StockOptionLevel, TrainingTimesLastYear, BusinessTravelNum, DepartmentNum, MaritalStatusNum, OverTimeNum, JobInvolvementNum, JobSatisfactionNum, WorkLifeBalanceNum 

## Linear Regression -Reduced Model1 Attrition
```{r Linear Regression -Reduced Model1 Attrition}
Model1 <-AttritionNum~ Age + DistanceFromHome + EnvironmentSatisfaction + NumCompaniesWorked + StockOptionLevel + TrainingTimesLastYear + BusinessTravelNum + DepartmentNum + MaritalStatusNum + OverTimeNum + JobInvolvementNum + JobSatisfactionNum + WorkLifeBalanceNum
fit1 <- lm(Model1, data = train_sampled_reg)
summary(fit1)
```
Conclusion
----------
The factors which increases attrition rate in employees are: (because of their positive coefficient in Model)
1) More Business Travel
2) Office Distance From Home
3) Worked in more number of companies
4) OverTime to complete work
5) More number in present company
6) If he is not promoted from long time.

The factors which decreases attrition rate in employees are: (because of their negative coefficient in Model)
1) Higher Age of Employee
2) Good Environment Satisfaction
3) Good Job Involvement
4) Good Job Satisfaction
5) Good Relationship Satisfaction
6) Good Work Life Balance
7) More number of years in Current Role
8) More number of years with Current Manager.

The factors which adversely affect Attrition Rate means to very high extent are:
1) More Business Travel
2) Office Distance From Home
3) Worked in more number of companies
4) Overtime at work
5) Good Environment Satisfaction
6) Good Job Involvement
7) Good Job Satisfaction


## Linear Regression -Full Model Salary Prediction
```{r Linear Regression -Full Model Salary Prediction}
set.seed(1234)
splitPerc = .70
trainIndices = sample(1:dim(classification_data)[1],round(splitPerc * dim(classification_data)[1]))
train = classification_data[trainIndices,]
test = classification_data[-trainIndices,]
reg_train <- conv.attr.reg(train)
reg_test <- conv.attr.reg(test)

Model1 <-MonthlyIncome ~ .
fit1 <- lm(Model1, data = reg_train)
summary(fit1)
lm.pred.full <- predict(fit1, newdata = reg_test[,names(reg_test) != "MonthlyIncome"])
actuals <- reg_test$MonthlyIncome
predictions <- lm.pred.full
RMSE <- sqrt(mean((actuals - predictions)^2))
RMSE
```

## Linear Regression - Reduced Model1 Salary Prediction
```{r Linear Regression - Reduced Model1 Salary Prediction}
red_model1_sal <- -MonthlyIncome ~ PerformanceRatingNum + JobInvolvementNum + MaritalStatusNum + JobRoleNum + DepartmentNum + YearsWithCurrManager + TotalWorkingYears + StockOptionLevel + PercentSalaryHike + JobLevel

fit1 <- lm(red_model1_sal, data = reg_train)
summary(fit1)
lm.pred.full <- predict(fit1, newdata = reg_test[,names(reg_test) != "MonthlyIncome"])
actuals <- reg_test$MonthlyIncome
predictions <- lm.pred.full
RMSE <- sqrt(mean((actuals - predictions)^2))
RMSE
```

## Linear Regression - Reduced Model2 Salary Prediction
```{r Linear Regression - Reduced Model2 Salary Prediction}
red_model2_sal <- MonthlyIncome ~ JobRoleNum + 
  DepartmentNum + TotalWorkingYears + 
  PercentSalaryHike + JobLevel + 
  YearsWithCurrManager 

fit2 <- lm(red_model2_sal, data = reg_train)
summary(fit2)
lm.pred.full <- predict(fit2, newdata = reg_test[,names(reg_test) != "MonthlyIncome"])
actuals <- reg_test$MonthlyIncome
predictions <- lm.pred.full
RMSE <- sqrt(mean((actuals - predictions)^2))
RMSE
```


## Linear Regression - Reduced Model3 Salary Prediction
```{r Linear Regression - Reduced Model3 Salary Prediction}
red_model3_sal <- MonthlyIncome ~ JobRoleNum + DepartmentNum +  TotalWorkingYears + PercentSalaryHike + JobLevel + YearsAtCompany 

fit3 <- lm(red_model3_sal, data = reg_train)
summary(fit3)
lm.pred.full <- predict(fit3, newdata = reg_test[,names(reg_test) != "MonthlyIncome"])
actuals <- reg_test$MonthlyIncome
predictions <- lm.pred.full
RMSE <- sqrt(mean((actuals - predictions)^2))
RMSE
```

Conclusion
The Reduced Model2 has less RMSE. Lets uses that for salary prediction

# Selecting best model by RMSE and using entire dataset for Salary Prediction
```{r Selecting best model by RMSE and using entire dataset for Salary Prediction}
str(no_salary_data)
pred_data <- conv.attr.reg(no_salary_data)
lm.model.reduced <- lm(red_model2_sal, data = reg_train)
lm.pred.salary <- predict(lm.model.reduced, newdata = pred_data)
no.salary.prediction <- data.frame(ID = pred_data$ID, MonthlyIncome = round(lm.pred.salary))
path_out2 = '/Users/lijjumathew/Code/Github/MSDS-Doing-Datascience-Project2/Results/'
fileName2 = paste(path_out, 'Case2PredictionsMathewSalary.csv',sep = '')
#write.csv(no.salary.prediction, fileName2, row.names = F)
```
